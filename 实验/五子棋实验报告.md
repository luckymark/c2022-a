# 五子棋实验报告

王炯翔 2022080909001 

#### 1. 功能

- 有玩家对战、与AI对战、观看ai对战三种五子棋玩法可选

- 与AI对战时可选黑白棋

- 可以进行连续多步的悔棋

- 由AI创作的高雅背景音乐

#### 2. 设计思路

1. 使用工具
   
   - 使用了EasyX图形库进行棋盘棋子绘制、窗口控制与鼠标键入信息接收

2. 模块划分
   
   - 头文件title.h
   - 用于绘制棋盘棋子、悔棋控制与擦除的函数存在Draw.cpp中
   - 用于判断成功落子与连棋的函数存在PieceSet.cpp中
   - 用于AI计算落子的函数存在AI.cpp中
   - main函数在FiveinaRow.cpp中
   - 三种对战玩法的函数分别存在playerVSplayer.cpp,playerVSAI.cpp,AIVSAI.cpp中

3. 主要函数与算法逻辑
   
   1. 悔棋相关函数
      
      1. clear(int x, int y)
         - 用于清空棋盘上坐标为(x,y)的棋子图形
         - 用清空小正方形的方式清空圆，防止留下边线，再以(x,y)为中心的补齐格线
         - 针对在棋盘边缘的悔棋需要再清理超出棋盘的格线，并由于clearrectangle()的特质，还需再补齐棋盘边缘
      2. regret()
         - 运用全局变量num计数棋盘上的棋子，order[][]记录落子的顺序
         - 当落子在(x,y)时,num++,order[x][y]=num，记录落子顺序与落子总个数
           - 当点击悔棋时，执行regret()，确认num!=0，即棋盘上有棋子后，遍历棋盘，找到order值为num的坐标(x,y)，执行clear(x,y)，再清空该点的order值、map值，num--，改变棋子颜色，并立刻跳出循环，悔棋结束
   
   2. 判断连棋函数judge(int x, int y，int color)
      
      - 简单的连棋条件罗列
      - 先检索棋子周围是否有同色棋子
      - 如果有，在连棋方向上检索是否有五颗连子，有则将全局变量check标记为color
   
   3. AI判断落子函数AI(int x, int y)
      
      1. 基本结构
         
         - 分为进攻评估和防守评估两部分进行估值
         - relief函数用于清空使用的数组
      
      2. 设计思路
         
         - 基于棋盘大小、测试效果与五子棋基本连棋思路将检索范围限制在目标棋子正负五格以内
         
         - 假定落子在检索棋子处，检查是否完成连棋
         
         - 再遍历检索棋子周围正负四格并假定落子，再检查是否完成连棋
         
         - 如此类推，每当出现检查到一次可能的连棋发生就增加分数
      
      3. 一些细节
         
         1. dcheck数组
            
            1. 用于复用检查
            
            2. 某一位置在更早一轮的检查中完成了连棋，便不能再计入后续的检查中，以免出现重复计分，使得AI过于重视眼前
            
            3. 此时便需要复用检查数组dcheck，来记录已经贡献过分数的位置
         
         2. defend
            
            1. 必防棋子的优先级低于必杀棋子
            
            2. 因此出现必防情况时不能直接跳出循环，而应等待检索完成确定没有必杀棋子后，再输出必防棋子
      
      4. 缺点？
         
         1. 该函数的估值部分曾是用函数包装，但由于bug实在不知道出现在何处，不得已改回了两部分代码相似度极高的形式
         
         2. 关于mark值的取值和调节过于粗糙，基本上凭借简单的棋谱、数学知识以及反复的测试与调节，希望未来能学习更科学合理的估值方法并重构代码
         
         3. 这套算法的致命问题：它无法考虑对方下一步的落子，只能考虑到”如果下在这个位置，再下一颗就能够完成连棋“的情况，而非”如果下在这个位置，哪怕对手做出应对，我再下一颗也能完成连棋“，这也直接导致了估值的难度上升

#### 3. 运行效果

- 在个人测试与玩家测试中表现较好
  AI执黑时
  ![pSHycd0.jpg](https://s1.ax1x.com/2023/02/16/pSHycd0.jpg)
  AI执白时
  ![pSbWq5n.md.png](https://s1.ax1x.com/2023/02/17/pSbWq5n.md.png)

- 在朋友的AI对阵中表现良好
  ![pSbfCVJ.md.jpg](https://s1.ax1x.com/2023/02/17/pSbfCVJ.md.jpg)

- 在复杂的交叉运算点能够进行较为良好的估值
  ![pSbfkP1.jpg](https://s1.ax1x.com/2023/02/17/pSbfkP1.jpg)

- 开局时AI的落子速度在3s左右，一定的落子量后速度加快到1s-2s

- 待改进部分
  
  - 对AI落子的精确度没有量化把握，赋值凭借测试而非准确计算，调试极困难，需要引入更科学合理的记值方式
  - 未采用更合理的剪枝方法，开局时计算量大，运行速度不如人意

#### 4. 参考资料

- [EasyX文档](https://docs.easyx.cn/zh-cn/mouse-operations)
- [Linux C编程一站式学习](http://akaedu.github.io/book/index.html)
- [CSDN - 专业开发者社区](https://www.csdn.net/?spm=1001.2101.3001.4476)
- [知乎](https://www.zhihu.com/hot)
- [Text-to-Music](https://huggingface.co/spaces/Mubert/Text-to-Music)
